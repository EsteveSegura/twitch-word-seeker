<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <h1>sad</h1>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.0/socket.io.js"></script>
    <script>
        //Generate random token
        let date = Date.now();
        let random = Math.random();
        let dateAndRandom = date.toString() + random.toString();
        let cleanToToken = dateAndRandom.split('.')
        let token = cleanToToken[0] + cleanToToken[1]
        let timeStampTwitch = "00:00:00"
        let timeStampMessage = "00:00:00"
        let testAdd = []

        console.log(token.toString())
        let socket = io.connect(`http://localhost:3000/?token=${token}`);//${token}

        socket.on('time', (body) => {
            console.log(body)
            timeStampTwitch = body
        })

        console.log(socket)
        let check = 0;
        let newTimestamp;
        let speech = () => {
            let x = "lol";

            let final_transcript = ""
            let recognition = new webkitSpeechRecognition();

            recognition.lang = "es"
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.start();
            recognition.onresult = (event) => {
                final_transcript = ''
                let interim_transcript = '';

                //console.log(event.results)
                
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {
                        if(check == 0){
                            newTimestamp = timeStampTwitch
                        }
                        check++;
                        console.log(newTimestamp)
                        interim_transcript += event.results[i][0].transcript;
                        console.log(interim_transcript)
                        //socket.emit('caption', { body: interim_transcript, token: token });
                    }
                }
                
                if (final_transcript != '') {
                    testAdd.push({text: final_transcript, startTimestamp: newTimestamp})
                    socket.emit('caption',  {body: final_transcript, token:token});
                    check = 0;
                }
            };

            recognition.onend = function () {
                recognition.start();
            }
        }

        setInterval(() => {
            console.log(testAdd)

        }, 5000);

        if (!('webkitSpeechRecognition' in window)) {
            alert("Sorry you require a browser that supports speech recognition");
        }
        else {
            speech();
        }
    </script>
</body>

</html>